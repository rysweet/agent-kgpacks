scenario:
  name: "Copilot Launch - Hook Verification"
  description: "Verify hooks work after copilot launch command"
  type: cli
  tags: [critical, hooks, copilot]

  prerequisites:
    - "amplihack is installed with PR fix"
    - "Python 3.10+ is available"

  steps:
    # Phase 1: Launch copilot (this should configure hooks)
    - action: launch
      target: "bash"
      args: ["-c", "amplihack copilot --help"]
      timeout: 30s
      description: "Run copilot command to trigger hook setup"

    - action: verify_exit_code
      expected: 0

    # Phase 2: Verify CLAUDE.md exists
    - action: launch
      target: "ls"
      args: ["-la", "$HOME/.amplihack/CLAUDE.md"]
      description: "Verify CLAUDE.md exists after copilot"

    - action: verify_exit_code
      expected: 0

    # Phase 3: Verify .claude directory
    - action: launch
      target: "ls"
      args: ["-d", "$HOME/.amplihack/.claude"]
      description: "Verify .claude directory exists"

    - action: verify_exit_code
      expected: 0

    # Phase 4: Test hooks work without ImportError
    - action: launch
      target: "bash"
      args:
        [
          "-c",
          'echo ''{"toolUse": {"name": "Bash", "input": {"command": "pwd"}}}'' | python3 $HOME/.amplihack/.claude/tools/xpia/hooks/pre_tool_use.py 2>&1',
        ]
      description: "Test PreToolUse hook"

    - action: verify_output
      contains: "{}"
      description: "Should return empty JSON (allow)"

    # Should not contain ImportError
    - action: launch
      target: "bash"
      args:
        [
          "-c",
          'echo ''{"toolUse": {"name": "Bash", "input": {"command": "pwd"}}}'' | python3 $HOME/.amplihack/.claude/tools/xpia/hooks/pre_tool_use.py 2>&1 | grep -i "ImportError" && exit 1 || exit 0',
        ]
      description: "Verify no ImportError"

    - action: verify_exit_code
      expected: 0

    # Phase 5: Test all hooks execute successfully
    - action: launch
      target: "python3"
      args: ["$HOME/.amplihack/.claude/tools/amplihack/hooks/session_start.py"]
      timeout: 15s
      description: "SessionStart hook should work"

    - action: verify_exit_code
      expected: 0

    - action: launch
      target: "bash"
      args:
        [
          "-c",
          'echo ''{"toolUse": {"name": "Read", "input": {}}, "output": ""}'' | python3 $HOME/.amplihack/.claude/tools/amplihack/hooks/post_tool_use.py',
        ]
      description: "PostToolUse hook should work"

    - action: verify_exit_code
      expected: 0

    - action: launch
      target: "python3"
      args: ["$HOME/.amplihack/.claude/tools/amplihack/hooks/stop.py"]
      timeout: 30s
      description: "Stop hook should work"

    - action: verify_exit_code
      expected: 0

    - action: launch
      target: "python3"
      args: ["$HOME/.amplihack/.claude/tools/amplihack/hooks/pre_compact.py"]
      timeout: 35s
      description: "PreCompact hook should work"

    - action: verify_exit_code
      expected: 0

    # Phase 6: Verify statusline hook works
    - action: launch
      target: "bash"
      args: ["$HOME/.amplihack/.claude/tools/statusline.sh"]
      timeout: 5s
      description: "Statusline hook should work"

    - action: verify_exit_code
      expected: 0

    - action: verify_output
      matches: ".*"
      description: "Should return formatted status line"
